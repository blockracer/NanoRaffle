<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano River | Raffle</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="rivercat.ico" type="image/x-icon">
  <link rel="shortcut icon" href="rivercat.ico" type="image/x-icon">
</head>

<body>
	<script>
  // WebSocket variable
  let websocket;

  // Inline Web Worker script using Blob
  const workerScript = `
    ${document.getElementById('worker-script')?.textContent || ''}
  `;

  // Create a Blob from the workerScript
  const blob = new Blob([workerScript], { type: 'application/javascript' });

  // Create a Web Worker from the Blob
  const workerBlobURL = URL.createObjectURL(blob);
  const myWorker = new Worker(workerBlobURL);

  // Start the background task
  myWorker.postMessage('Start background task');

  // Handle messages from the Web Worker
  myWorker.onmessage = function (event) {
    console.log('Main thread received message from Web Worker:', event.data);
  };

  // Cleanup when done (optional)
  myWorker.onclose = function () {
    URL.revokeObjectURL(workerBlobURL);
  };
</script>

<script id="worker-script" type="worker-script">
  // Include the content of worker.js here
  function checkConnection() {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
      console.log('WebSocket connection is open');
    } else {
      console.log('WebSocket connection is closed');
      // Reconnect to the WebSocket
      websocket = new WebSocket('wss://balancews.nanoriver.io');
    }
  }

  // Set up an interval to call checkConnection every 5 seconds
  const intervalId = setInterval(checkConnection, 5000);

  // Handle messages from the main thread (optional)
  self.onmessage = function (event) {
    console.log('Web Worker received message:', event.data);
    // You can handle additional messages from the main thread if needed
  };

  // Stop the interval when the Web Worker is terminated (optional)
  self.onclose = function () {
    clearInterval(intervalId);
  };
  function checkConnection() {
    if (websocket.readyState === WebSocket.OPEN) {
      console.log('WebSocket connection is open');
    } else {
      console.log('WebSocket connection is closed');
      // Reconnect to the WebSocket
      websocket = new WebSocket('wss://balancews.nanoriver.io');
    }
  }

  // Set up an interval to call checkConnection every 5 seconds
  const intervalId = setInterval(checkConnection, 5000);

  // Handle messages from the main thread (optional)
  self.onmessage = function (event) {
    console.log('Web Worker received message:', event.data);
    // You can handle additional messages from the main thread if needed
  };

  // Stop the interval when the Web Worker is terminated (optional)
  self.onclose = function () {
    clearInterval(intervalId);
  };
</script>

    <header>
        <div id="logo-container">
            <img id="logo" src="/logo.png" alt="Nano Raffle Logo">
        </div>
    </header>

    <nav>
        <a href="/entries.html">CURRENT ENTRIES</a>
        <a href="/winners.html">WINNERS</a>
    </nav>

    <main>
        <h1 id="pageTitle">NANO RAFFLE</h1>
        <hr class="divider">
        <div id="entryMessage">Ӿ1 PER ENTRY</div><br><br>
        <div id="nanoAddress">
            <strong>NANO ADDRESS:</strong><br><br>
            <b>nano_38sbai751batgzspmtf4x3bky7pcd3br19upemzbtb9jafaj4pdgbpo4phr5</b>
            <button id="copyButton" onclick="copyToClipboard()"><i class="fas fa-copy"></i></button>
        </div>
        <div id="qrcodeContainer">
            <div id="qrcode" onclick="openNanoLink()"></div>
        </div>
        <div id="websocketMessages"></div>
        <div id="countdownTimer"></div><br><br>
        <hr class="divider">
    </main>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

    <script>
        let a = "?r=Armour";
        // Function to update countdown timer
        function updateCountdownTimer() {
            // Fetch time from /time.json
            fetch('/time.json')
                .then(response => response.json())
                .then(data => {
                    const currentTime = Math.floor(Date.now() / 1000);
                    const remainingTime = data.time - currentTime;

                    // Calculate days, hours, minutes, and seconds
                    const days = Math.floor(remainingTime / 86400);
                    const hours = Math.floor((remainingTime % 86400) / 3600);
                    const minutes = Math.floor((remainingTime % 3600) / 60);
                    const seconds = remainingTime % 60;

                    // Display the countdown timer
                    const countdownTimer = document.getElementById('countdownTimer');
                    countdownTimer.textContent = `Time Remaining: ${days}d ${hours}h ${minutes}m ${seconds}s`;

                    // Check if the countdown timer reached 0
                    if (remainingTime <= 0) {
                        // Reload the page to update content based on the latest data
                        location.reload();
                    }
                });
        }

        // Function to display the most recent message in the UI
        function displayMessage(message) {
            const websocketMessages = document.getElementById('websocketMessages');
            websocketMessages.textContent = "CURRENT POT: Ӿ" + message;

            // Clear previous QR code
            const qrcodeElement = document.getElementById('qrcode');
            qrcodeElement.innerHTML = '';

            // Generate QR Code
            const qrcode = new QRCode(qrcodeElement, {
                text: 'nano:nano_38sbai751batgzspmtf4x3bky7pcd3br19upemzbtb9jafaj4pdgbpo4phr5?amount=1000000000000000000000000000000',
                width: 256,
                height: 256
            });
        }
        	websocket = new WebSocket('wss://balancews.nanoriver.io');

	
	setInterval(checkConnection, 5000);
	    websocket.onopen = () => {
   		 console.log('WebSocket connection opened');
  	};
  


        // Event listener for WebSocket messages
        websocket.addEventListener('message', (event) => {
            const message = JSON.parse(event.data);
            displayMessage(message);
        });

	 websocket.addEventListener('close', (event) => {
        	// Call your method when WebSocket disconnects
        	//websocket = new WebSocket('wss://balancews.nanoriver.io');
    	});

        // Initial call to update countdown timer
        updateCountdownTimer();

        // Update countdown timer every second
        setInterval(updateCountdownTimer, 1000);


        function openNanoLink() {
            const nanoLink = 'nano:nano_38sbai751batgzspmtf4x3bky7pcd3br19upemzbtb9jafaj4pdgbpo4phr5?amount=1000000000000000000000000000000';
            window.location.href = nanoLink;
        }
        // Function to copy Nano address to clipboard
        function copyToClipboard() {
            const nanoAddress = 'nano_38sbai751batgzspmtf4x3bky7pcd3br19upemzbtb9jafaj4pdgbpo4phr5';
            const textarea = document.createElement('textarea');
            textarea.value = nanoAddress;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            //alert('Nano address copied to clipboard!');
        }

         // Function to open Nano Cat link in a new tab
         function openNanoCatLink() {
            // Extract the image name from the src attribute
            const imageUrl = document.getElementById('nanoCatImage').src;
            const imageName = imageUrl.split('/').pop().split('.')[0];
            
            // Construct the link with the asset ID
            const assetId = imageName; // Use imageName directly as assetId
            const link = `https://nanswap.com/art/assets/${assetId}${a}`;
            
            // Open the link in a new tab
            window.open(link, '_blank');
        }
	    function checkConnection() {
    		if (websocket.readyState === WebSocket.OPEN) {
        		console.log('WebSocket connection is open');
    		} else {
        		console.log('WebSockett connection is closed');
        		websocket = new WebSocket('wss://balancews.nanoriver.io');
    	    }
}

    </script>
    <div>
        <h1 id="pageTitle">EXTRA PRIZES</h1>
        <img id="nanoCatImage" src="/0P5CHo71ndu.png" alt="Nyano Cat" style="max-width: 100%; width: 300px; height: auto;" onclick="openNanoCatLink()" />
        <p>The next winner will also receive this Nyano Cats NaNFT on <a href="https://nanswap.com/art?r=Armour" style="color:#2980b9" target="_blank">Nanswap Art</a>.<br><strong>IMPORTANT:</strong> Please enter this raffle with the Nano Address linked to your Nanswap account for transferring the asset.</p>
    </div>

    <footer>
        <div class="social-links">
            <a href="#" class="social-icon"><i class="fab fa-reddit"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-discord"></i></a>
            <br><br>Powered by <a href="https://armour.dev" style="color:#fff">Armour Solutions</a>
        </div>
    </footer>


</body>

</html>
